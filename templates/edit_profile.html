{% extends "base_template.html" %}
{% block content %}
{% load static %}
<html dir="rtl">
<head>
    <meta charset="utf-8">
    <title>ویرایش پروفایل</title>
    <link rel="stylesheet" href="{% static 'css/edit_profile.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="profile-container">
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <h2 class="profile-header">ویرایش پروفایل کاربری</h2>

            <div class="profile-image-section">
                {% if user_profile.profile_image %}
                    <img src="{{ user_profile.profile_image.url }}" alt="تصویر پروفایل" id="profile-image-preview">
                {% else %}
                    <img src="{% static 'image/images.png' %}" alt="تصویر پیش‌فرض" id="profile-image-preview">
                {% endif %}

                {% if user_profile.profile_image %}
                    <button type="submit" name="delete_image" value="1" class="upload-btn" style="background: red;">
                        <i class="fas fa-trash"></i> حذف تصویر پروفایل
                    </button>
                {% endif %}

                <div class="custom-upload-btn">
                    <button type="button" class="upload-btn"><i class="fas fa-camera"></i> انتخاب تصویر جدید</button>
                    <input type="file" name="profile_image" accept="image/*" id="id_profile_image">
                </div>
            </div>

            <div class="form-group"><label>نام کاربری:</label>{{ user_form.username }}</div>
            <div class="form-group"><label>نام خانوادگی:</label>{{ user_form.last_name }}</div>
            <div class="form-group"><label>شماره تلفن:</label>{{ user_form.phone }}</div>
            <div class="form-group"><label>ایمیل:</label>{{ user_form.email }}</div>

            <div id="map" style="height: 400px; border-radius: 10px; margin-bottom: 20px;"></div>
            <input type="hidden" name="lat" id="lat" value="{{ request.user.latitude|default:32.6546 }}">
            <input type="hidden" name="lng" id="lng" value="{{ request.user.longitude|default:51.6680 }}">

            <button type="submit" class="submit-btn"><i class="fas fa-save"></i> ذخیره تغییرات</button>
        </form>
    </div>

    <div id="toast" class="toast"><span id="toast-message"></span><i class="fas fa-check"></i></div>
    <script>
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-message');
            const icon = toast.querySelector('i');
            msg.textContent = message;
            icon.className = isError ? 'fas fa-times' : 'fas fa-check';
            toast.classList.toggle('error', isError);
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        document.getElementById('id_profile_image')?.addEventListener('change', function(event) {
            const input = event.target;
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profile-image-preview').src = e.target.result;
                    showToast('عکس جدید انتخاب شد');
                };
                reader.readAsDataURL(input.files[0]);
            }
        });
        // {% if messages %}
        //     {% for message in messages %}
        //         showToast("{{ message }}", "{{ message.tags }}" == "error");
        //     {% endfor %}
        // {% endif %}

let map, marker;

function initMap() {
    const defaultLocation = { lat: 32.6546, lng: 51.6680 }; // اصفهان

    function loadMap(location) {
        // ست کردن فیلدهای hidden
        document.getElementById("lat").value = location.lat;
        document.getElementById("lng").value = location.lng;

        // ایجاد نقشه
        map = new google.maps.Map(document.getElementById("map"), {
            center: location,
            zoom: 13
        });

        // ایجاد مارکر
        marker = new google.maps.Marker({
            position: location,
            map: map,
            draggable: true
        });

        function updateInputs(latLng) {
            document.getElementById("lat").value = latLng.lat();
            document.getElementById("lng").value = latLng.lng();
        }

        // وقتی مارکر جابجا شد
        marker.addListener("dragend", function(event) {
            updateInputs(event.latLng);
        });

        // وقتی روی نقشه کلیک شد
        map.addListener("click", function(event) {
            marker.setPosition(event.latLng);
            updateInputs(event.latLng);
        });
    }

    // استفاده از GPS کاربر
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                loadMap(userLocation);
            },
            function() {
                loadMap(defaultLocation); // اگر اجازه داده نشد
            }
        );
    } else {
        loadMap(defaultLocation); // مرورگر GPS ندارد
    }
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYJG1zkphN4CtpAsCBF_xUzBfgpRreJ7A&libraries=places&language=fa&callback=initMap" async defer></script>

{% endblock content %}

